function u(){throw new Error("Failed pattern match")}function H(t,n){return n>0?Math.floor(t/n):n<0?-Math.floor(t/-n):0}var he=function(t){return function(n){return function(){return t(n())}}},Ge=function(t){return function(){return t}};var cr={map:he};var sr={apply:t=>n=>()=>{let r=t(),a=n();return bt.pure(r(a))()},Functor0:()=>cr},bt={pure:Ge,Apply0:()=>sr};var Vt=function(t){return function(n){return t+n|0}};var U=function(t){return function(n){if(n===0)return 0;var r=Math.abs(n);return(t%r+r)%r}};var N=function(t){throw new Error(t)};var s=(t,n,r)=>({tag:t,_1:n,_2:r});var qt=t=>s("HalfWord",t);var Ce=["G","A","S","M"],Ae=t=>{if(t.tag==="Byte")return[t._1];if(t.tag==="HalfWord")return[U(t._1)(256),H(t._1,256)];if(t.tag==="Word"){let n=H(t._1,65536),r=U(t._1)(65536);return[U(r)(256),H(r,256),U(n)(256),H(n,256)]}return t.tag==="NamedLabel"?[U(t._1)(256),H(t._1,256),U(t._2)(256),H(t._2,256)]:N("Impossible")},Zt=t=>{if(t.tag==="Byte")return 1;if(t.tag==="HalfWord")return 2;if(t.tag==="Word"||t.tag==="NamedLabel"||t.tag==="Sym")return 4;u()};var Ht=t=>t,L=Ht("LT"),E=Ht("GT"),Q=Ht("EQ");var h=(t,n)=>({tag:t,_1:n}),g=h("Nothing"),J=t=>h("Just",t);var Bt=t=>{if(t.tag==="Nothing")return!0;if(t.tag==="Just")return!1;u()};var st={map:t=>n=>n.tag==="Just"?h("Just",t(n._1)):g};var et=t=>{let n=t.Eq0(),r={eq:a=>e=>a.tag==="Nothing"?e.tag==="Nothing":a.tag==="Just"&&e.tag==="Just"&&n.eq(a._1)(e._1)};return{compare:a=>e=>{if(a.tag==="Nothing")return e.tag==="Nothing"?Q:L;if(e.tag==="Nothing")return E;if(a.tag==="Just"&&e.tag==="Just")return t.compare(a._1)(e._1);u()},Eq0:()=>r}};var Ne=function(t){return function(n){return t===n}};var Le=Ne;var Ee=Ne;var qe={eq:Ee};var vt={eq:Le};var Be=function(t){return function(n){return function(r){return function(a){return function(e){return a<e?t:a===e?n:r}}}}};var Pe=Be;var Je=Be;var it={compare:Je(L)(Q)(E),Eq0:()=>qe};var pt={compare:Pe(L)(Q)(E),Eq0:()=>vt};var ee=(t,n)=>({tag:"CodeLabel",_1:t,_2:n});var gr=et(it).compare;var Dr={eq:t=>n=>(t._1.tag==="Nothing"?n._1.tag==="Nothing":t._1.tag==="Just"&&n._1.tag==="Just"&&t._1._1===n._1._1)&&t._2===n._2},Pt={compare:t=>n=>{let r=gr(t._1)(n._1);return r==="LT"?L:r==="GT"?E:pt.compare(t._2)(n._2)},Eq0:()=>Dr};var R=function(t){return function(n){for(var r=n.length,a=new Array(r),e=0;e<r;e++)a[e]=t(n[e]);return a}};var Jt={map:R};var Oe=t=>t;var _t=(t,n)=>({tag:t,_1:n});var We=t=>t;var ae={map:t=>n=>t(n)};var je={apply:t=>n=>t(n),Functor0:()=>ae},wr={bind:t=>n=>n(t),Apply0:()=>je},Cr={pure:We,Apply0:()=>je},mt={Applicative0:()=>Cr,Bind1:()=>wr};var dt=(t,n)=>({tag:t,_1:n});var Ue={tailRecM:t=>{let n=r=>{let a=r,e=!0,o;for(;e;){let d=a;if(d.tag==="Loop"){a=t(d._1);continue}if(d.tag==="Done"){e=!1,o=d._1;continue}u()}return o};return r=>n(t(r))},Monad0:()=>mt};var ze=function(n){return function(r){return function(a){return function(){return n(r,a)}}}};var Qe=function(t,n){return n.push(t)};var Ve=ze(Qe);var ie=function(t){return function(n){return function(r){for(var a=n,e=r.length,o=e-1;o>=0;o--)a=t(r[o])(a);return a}}},Y=function(t){return function(n){return function(r){for(var a=n,e=r.length,o=0;o<e;o++)a=t(a)(r[o]);return a}}};var de=t=>t;var Ze=t=>{let n=t.Apply0();return r=>a=>r.foldr(e=>{let o=a(e);return d=>n.apply(n.Functor0().map(i=>Oe)(o))(d)})(t.pure())},He=t=>{let n=Ze(t);return r=>{let a=n(r);return e=>o=>a(o)(e)}};var ve={foldr:t=>n=>r=>{if(r.tag==="Nothing")return n;if(r.tag==="Just")return t(r._1)(n);u()},foldl:t=>n=>r=>{if(r.tag==="Nothing")return n;if(r.tag==="Just")return t(n)(r._1);u()},foldMap:t=>{let n=t.mempty;return r=>a=>{if(a.tag==="Nothing")return n;if(a.tag==="Just")return r(a._1);u()}}};var nt={foldr:ie,foldl:Y,foldMap:t=>{let n=t.mempty;return r=>nt.foldr(a=>e=>t.Semigroup0().append(r(a))(e))(n)}};var p=(t,n)=>({tag:"Tuple",_1:t,_2:n});var ft=t=>t._2;var gt=t=>t._1;var ut=function(t){return t};var un=function(){function t(e){return[e]}function n(e){return function(o){return[e,o]}}function r(e){return function(o){return function(d){return[e,o,d]}}}function a(e){return function(o){return e.concat(o)}}return function(e){return function(o){return function(d){return function(i){return function($){function c(l,S){switch(S-l){case 0:return d([]);case 1:return o(t)(i($[l]));case 2:return e(o(n)(i($[l])))(i($[l+1]));case 3:return e(e(o(r)(i($[l])))(i($[l+1])))(i($[l+2]));default:var G=l+Math.floor((S-l)/4)*2;return e(o(a)(c(l,G)))(c(G,S))}}return c(0,$.length)}}}}}}();var cn=t=>t;var sn={traverse:t=>n=>r=>{if(r.tag==="Nothing")return t.pure(g);if(r.tag==="Just")return t.Apply0().Functor0().map(J)(n(r._1));u()},sequence:t=>n=>{if(n.tag==="Nothing")return t.pure(g);if(n.tag==="Just")return t.Apply0().Functor0().map(J)(n._1);u()},Functor0:()=>st,Foldable1:()=>ve};var Ot={traverse:t=>{let n=t.Apply0();return un(n.apply)(n.Functor0().map)(t.pure)},sequence:t=>Ot.traverse(t)(cn),Functor0:()=>Jt,Foldable1:()=>nt};var na=function(t,n){if(t<1)return[];var r=new Array(t);return r.fill(n)},ra=function(t,n){for(var r=[],a=0,e=0;e<t;e++)r[a++]=n;return r},aa=typeof Array.prototype.fill=="function"?na:ra;var Ct=function(t,n,r){return r.length===0?t({}):n(r[0])(r.slice(1))};var Dt=function(t,n,r,a){for(var e=0,o=a.length;e<o;e++)if(r(a[e]))return t(e);return n};var xt=function(t,n,r){return r.slice(t,n)};var rt=t=>n=>(()=>{let r=Ve(n);return()=>{let a=[...t];return r(a)(),a}})()();var ce=t=>{let n=t.length-1|0;return n>=0&&n<t.length?h("Just",t[n]):g};function ln(t){return t.buffer}function X(t){return function(r,a,e){if(a===null)return new t(r);var o=r.byteLength,d=t.BYTES_PER_ELEMENT,i=Math.min(o,a>>>0);if(e===null)return new t(r,i);var $=Math.min((o-i)/d,e);return new t(r,i,$)}}var ia=X(Uint8ClampedArray),da=X(Uint32Array),ua=X(Uint16Array),$a=X(Uint8Array),ca=X(Int32Array),sa=X(Int16Array),le=X(Int8Array),pa=X(Float32Array),la=X(Float64Array);var Y$=Number.POSITIVE_INFINITY,X$=Number.NEGATIVE_INFINITY;var mn=function(t){return function(n){return function(r){return function(a){return function(e){return function(o){for(var d=[],i=o;;){var $=e(i);d.push(r($));var c=a($);if(t(c))return d;i=n(c)}}}}}}};var ya=t=>{if(t.tag==="Just")return t._1;u()};var fn={unfoldr1:mn(Bt)(ya)(gt)(ft)};function St(t){return t.charCodeAt(0)}var _=(t,n,r)=>({tag:t,_1:n,_2:r});var $t=_("Nil");var yn=function(t){return function(n){return function(r){return function(a){return function(e){return function(o){for(var d=[],i=o;;){var $=e(i);if(t($))return d;var c=n($);d.push(r(c)),i=a(c)}}}}}}};var ha=t=>{if(t.tag==="Just")return t._1;u()};var _e={unfoldr:yn(Bt)(ha)(gt)(ft),Unfoldable10:()=>fn};var j=(t,n,r,a,e,o,d)=>({tag:t,_1:n,_2:r,_3:a,_4:e,_5:o,_6:d}),It=(t,n,r,a)=>({tag:t,_1:n,_2:r,_3:a});var In=(t,n,r)=>({tag:"SplitLast",_1:t,_2:n,_3:r});var W=j("Leaf");var hn=It("IterLeaf");var b=(t,n,r,a)=>{if(r.tag==="Leaf"){if(a.tag==="Leaf")return j("Node",1,1,t,n,r,a);if(a.tag==="Node")return j("Node",1+a._1|0,1+a._2|0,t,n,r,a);u()}if(r.tag==="Node"){if(a.tag==="Leaf")return j("Node",1+r._1|0,1+r._2|0,t,n,r,a);if(a.tag==="Node")return j("Node",r._1>a._1?1+r._1|0:1+a._1|0,(1+r._2|0)+a._2|0,t,n,r,a)}u()};var ht=(t,n,r,a)=>{if(r.tag==="Leaf")return a.tag==="Leaf"?j("Node",1,1,t,n,W,W):a.tag==="Node"&&a._1>1?a._5.tag==="Node"&&(()=>{if(a._6.tag==="Leaf")return a._5._1>0;if(a._6.tag==="Node")return a._5._1>a._6._1;u()})()?b(a._5._3,a._5._4,b(t,n,r,a._5._5),b(a._3,a._4,a._5._6,a._6)):b(a._3,a._4,b(t,n,r,a._5),a._6):b(t,n,r,a);if(r.tag==="Node")return a.tag==="Node"?a._1>(r._1+1|0)?a._5.tag==="Node"&&(()=>{if(a._6.tag==="Leaf")return a._5._1>0;if(a._6.tag==="Node")return a._5._1>a._6._1;u()})()?b(a._5._3,a._5._4,b(t,n,r,a._5._5),b(a._3,a._4,a._5._6,a._6)):b(a._3,a._4,b(t,n,r,a._5),a._6):r._1>(a._1+1|0)?r._6.tag==="Node"&&(()=>{if(r._5.tag==="Leaf")return 0<=r._6._1;if(r._5.tag==="Node")return r._5._1<=r._6._1;u()})()?b(r._6._3,r._6._4,b(r._3,r._4,r._5,r._6._5),b(t,n,r._6._6,a)):b(r._3,r._4,r._5,b(t,n,r._6,a)):b(t,n,r,a):a.tag==="Leaf"&&r._1>1?r._6.tag==="Node"&&(()=>{if(r._5.tag==="Leaf")return 0<=r._6._1;if(r._5.tag==="Node")return r._5._1<=r._6._1;u()})()?b(r._6._3,r._6._4,b(r._3,r._4,r._5,r._6._5),b(t,n,r._6._6,a)):b(r._3,r._4,r._5,b(t,n,r._6,a)):b(t,n,r,a);u()};var Gn=(t,n,r,a)=>{if(a.tag==="Leaf")return In(t,n,r);if(a.tag==="Node"){let e=Gn(a._3,a._4,a._5,a._6);return In(e._1,e._2,ht(t,n,r,e._3))}u()},Ga=(t,n)=>{if(t.tag==="Leaf")return n;if(t.tag==="Node"){let r=Gn(t._3,t._4,t._5,t._6);return ht(r._1,r._2,r._3,n)}u()};var bn=t=>n=>r=>{let a=e=>{if(e.tag==="Leaf")return W;if(e.tag==="Node"){let o=t.compare(r)(e._3);if(o==="LT")return ht(e._3,e._4,a(e._5),e._6);if(o==="GT")return ht(e._3,e._4,e._5,a(e._6));if(o==="EQ"){let d=n(e._4);if(d.tag==="Nothing")return Ga(e._5,e._6);if(d.tag==="Just")return j("Node",e._1,e._2,e._3,d._1,e._5,e._6)}}u()};return a};var Wt=t=>n=>a=>{let e=a,o=!0,d;for(;o;){let i=e;if(i.tag==="Leaf"){o=!1,d=g;continue}if(i.tag==="Node"){let $=t.compare(n)(i._3);if($==="LT"){e=i._5;continue}if($==="GT"){e=i._6;continue}if($==="EQ"){o=!1,d=h("Just",i._4);continue}}u()}return d};var ba=t=>n=>a=>{let e=a,o=!0,d;for(;o;){let i=e;if(i.tag==="IterLeaf"){o=!1,d=n();continue}if(i.tag==="IterEmit"){o=!1,d=t(i._1,i._2,i._3);continue}if(i.tag==="IterNode"){e=(c=>l=>{let S=c,G=l,F=!0,q;for(;F;){let B=S,M=G;if(M.tag==="Leaf"){F=!1,q=B;continue}if(M.tag==="Node"){if(M._6.tag==="Leaf"){S=It("IterEmit",M._3,M._4,B),G=M._5;continue}S=It("IterEmit",M._3,M._4,It("IterNode",M._6,B)),G=M._5;continue}u()}return q})(i._2)(i._1);continue}u()}return d};var Rn=ba((t,n,r)=>h("Just",p(p(t,n),r)))(t=>g);var Gt=t=>n=>r=>{let a=e=>{if(e.tag==="Leaf")return j("Node",1,1,n,r,W,W);if(e.tag==="Node"){let o=t.compare(n)(e._3);if(o==="LT")return ht(e._3,e._4,a(e._5),e._6);if(o==="GT")return ht(e._3,e._4,e._5,a(e._6));if(o==="EQ")return j("Node",e._1,e._2,n,r,e._5,e._6)}u()};return a};var wn=function(t){return function(n){return t.length===0?n:n.length===0?t:t.concat(n)}};var Cn={append:wn};var me={mempty:[],Semigroup0:()=>Cn};var jt=function(t){return t.split("")};var An=(()=>{let t=_e.unfoldr(Rn);return n=>t(It("IterNode",n,hn))})(),Tn=He(bt)(nt),Aa=(()=>{let t=Ot.traverse(bt);return n=>r=>t(r)(n)})(),ct=nt.foldMap(me)(de),Nn=Y(Vt)(0),Ta=nt.foldMap(me);var Ln=t=>n=>r=>{let a=(e,o)=>{let d=Wt(Pt)(o)(n);return d.tag==="Just"?[s("Byte",e),s("HalfWord",d._1-t|0)]:N("Impossible")};return e=>{if(e.tag==="KNoop")return[s("Byte",254)];if(e.tag==="KStop")return[s("Byte",255)];if(e.tag==="KLabel")return[];if(e.tag==="KQuote"){if(e._1.tag==="CstBool")return e._1._1?[s("Byte",192),s("Byte",1)]:[s("Byte",192),s("Byte",0)];if(e._1.tag==="CstInt")return[s("Byte",193),s("Word",e._1._1)];u()}if(e.tag==="KGetGlobal")return[s("Byte",200),s("Sym",e._1)];if(e.tag==="KSetGlobal")return[s("Byte",201),s("Sym",e._1)];if(e.tag==="KField")return[s("Byte",202),s("Byte",e._1)];if(e.tag==="KClosure"&&e._1._1.tag==="Nothing")return N("Impossible: Closure referencing null-namespace label");let o=d=>{if(e.tag==="KClosure"){if(e._1._1.tag==="Just")return N("Impossible: Closure referencing Undefined labels");u()}if(e.tag==="KApply")return[s("Byte",129)];if(e.tag==="KPush")return[s("Byte",131)];if(e.tag==="KPushMark")return[s("Byte",132)];if(e.tag==="KGrab")return[s("Byte",133)];if(e.tag==="KReturn")return[s("Byte",96)];if(e.tag==="KTailApply")return[s("Byte",102)];if(e.tag==="KAccess")return[s("Byte",225),s("Byte",e._1)];if(e.tag==="KLet")return[s("Byte",226)];if(e.tag==="KEndLet")return[s("Byte",227),s("Byte",e._1)];if(e.tag==="KDummies")return[s("Byte",228),s("Byte",e._1)];if(e.tag==="KUpdate")return[s("Byte",229),s("Byte",e._1)];if(e.tag==="K_i32_add")return[s("Byte",161)];if(e.tag==="K_i32_sub")return[s("Byte",162)];if(e.tag==="K_i32_mul")return[s("Byte",163)];if(e.tag==="K_i32_div")return[s("Byte",164)];if(e.tag==="K_i32_mod")return[s("Byte",165)];if(e.tag==="K_i32_equ")return[s("Byte",166)];if(e.tag==="K_i32_neq")return[s("Byte",167)];if(e.tag==="K_i32_le")return[s("Byte",168)];if(e.tag==="K_i32_lt")return[s("Byte",169)];if(e.tag==="K_log_and")return[s("Byte",170)];if(e.tag==="K_log_or")return[s("Byte",171)];if(e.tag==="K_log_xor")return[s("Byte",172)];if(e.tag==="K_log_not")return[s("Byte",173)];if(e.tag==="KBranch")return a(176,e._1);if(e.tag==="KBranchIf")return a(177,e._1);if(e.tag==="KBranchIfNot")return a(178,e._1);u()};if(e.tag==="KClosure"&&e._1._1.tag==="Just"){let d=e._1._1._1,i=Dt(J,g,$=>$===d,r);if(i.tag==="Just")return[s("Byte",128),s("NamedLabel",i._1,e._1._2)]}return o(!0)}},En=t=>{let n=(()=>{let a=Y(e=>{let o=e._2,d=e._1;return i=>i.tag==="KLabel"?p(d,Gt(Pt)(i._1)(d)(o)):p((()=>{if(i.tag==="KLabel")return d+0|0;if(i.tag==="KQuote"){if(i._1.tag==="CstBool")return d+2|0;if(i._1.tag==="CstInt")return d+5|0;u()}return i.tag==="KGetGlobal"||i.tag==="KSetGlobal"?d+5|0:i.tag==="KField"||i.tag==="KAccess"?d+2|0:i.tag==="KClosure"?d+5|0:i.tag==="KEndLet"||i.tag==="KDummies"||i.tag==="KUpdate"?d+2|0:i.tag==="KBranch"||i.tag==="KBranchIf"||i.tag==="KBranchIfNot"?d+3|0:d+1|0})(),o)})(p(0,W))(t.init)._2;return()=>{let e=0,o=[];Tn(t.init)(i=>()=>{let $=e;o.push(...Ln($)(a)(R(ut)(t.syms))(i));let c=e;return e=(()=>{if(i.tag==="KLabel")return c+0|0;if(i.tag==="KQuote"){if(i._1.tag==="CstBool")return c+2|0;if(i._1.tag==="CstInt")return c+5|0;u()}return i.tag==="KGetGlobal"||i.tag==="KSetGlobal"?c+5|0:i.tag==="KField"||i.tag==="KAccess"?c+2|0:i.tag==="KClosure"?c+5|0:i.tag==="KEndLet"||i.tag==="KDummies"||i.tag==="KUpdate"?c+2|0:i.tag==="KBranch"||i.tag==="KBranchIf"||i.tag==="KBranchIfNot"?c+3|0:c+1|0})()})();let d=[...o];return p(d,(()=>{let i=R(ut)(t.syms);return R($=>[(()=>{let c=(()=>{if($._1._1.tag==="Just"){let l=$._1._1._1;return Dt(J,g,S=>S===l,i)}if($._1._1.tag==="Nothing")return g;u()})();if(c.tag==="Nothing")return-1;if(c.tag==="Just")return c._1;u()})(),$._1._2,0+$._2|0])(An(a))})())}})()(),r=(()=>{let a=W,e=0,o=[],d=Aa(t.text)(c=>{let l=c._1.code,S=c._1.lbl;return()=>{let G=e,F=a;a=Gt(it)(S)(G)(F);let q=Y(I=>{let Z=I._2,D=I._1;return A=>A.tag==="KLabel"?p(D,Gt(Pt)(A._1)(D)(Z)):p((()=>{if(A.tag==="KLabel")return D+0|0;if(A.tag==="KQuote"){if(A._1.tag==="CstBool")return D+2|0;if(A._1.tag==="CstInt")return D+5|0;u()}return A.tag==="KGetGlobal"||A.tag==="KSetGlobal"?D+5|0:A.tag==="KField"||A.tag==="KAccess"?D+2|0:A.tag==="KClosure"?D+5|0:A.tag==="KEndLet"||A.tag==="KDummies"||A.tag==="KUpdate"?D+2|0:A.tag==="KBranch"||A.tag==="KBranchIf"||A.tag==="KBranchIfNot"?D+3|0:D+1|0})(),Z)})(p(0,W))(l)._2,B=0;Tn(l)(I=>()=>{let Z=B;o.push(...Ln(Z)(q)(R(ut)(t.syms))(I));let D=B;return B=(()=>{if(I.tag==="KLabel")return D+0|0;if(I.tag==="KQuote"){if(I._1.tag==="CstBool")return D+2|0;if(I._1.tag==="CstInt")return D+5|0;u()}return I.tag==="KGetGlobal"||I.tag==="KSetGlobal"?D+5|0:I.tag==="KField"||I.tag==="KAccess"?D+2|0:I.tag==="KClosure"?D+5|0:I.tag==="KEndLet"||I.tag==="KDummies"||I.tag==="KUpdate"?D+2|0:I.tag==="KBranch"||I.tag==="KBranchIf"||I.tag==="KBranchIfNot"?D+3|0:D+1|0})()})(),e=e+B|0;let $r=R(ut)(t.syms);return R(I=>[(()=>{let Z=(()=>{if(I._1._1.tag==="Just"){let D=I._1._1._1;return Dt(J,g,A=>A===D,$r)}if(I._1._1.tag==="Nothing")return g;u()})();if(Z.tag==="Nothing")return-1;if(Z.tag==="Just")return Z._1;u()})(),I._1._2,G+I._2|0])(An(q))}})(),i=[...o];return p(a,p(i,ct(d)))})();return{header:{name:t.name,compilerVersion:"v0.1.0"},text:r._2._1,entry:n._1,syms:R(ut)(t.syms),lbls:[...n._2,...r._2._2]}},Fn=t=>{let n=ct([[...R(a=>s("Byte",St(a)))(jt(t.header.name)),s("Byte",0)],[...R(a=>s("Byte",St(a)))(jt(t.header.compilerVersion)),s("Byte",0)]]),r=Ta(a=>Ae((()=>{if(a.tag==="Sym"){let e=a._1,o=Dt(J,g,d=>d===e,t.syms);if(o.tag==="Just")return s("Word",o._1)}return a.tag==="Sym"?N("Impossible: undefined symbol"):a})()))(ct([ct([R(a=>s("Byte",St(a)))(Ce),[s("Byte",5+n.length|0)],n]),ct((()=>{let a=[t.text,t.entry,[s("HalfWord",t.syms.length),...ct((()=>{let o=R(i=>[...R($=>s("Byte",St($)))(jt(i)),s("Byte",0)])(t.syms),d=R(qt)(Y(i=>$=>{let c=ce(i);return rt(i)((()=>{if(c.tag==="Just")return c._1;u()})()+Nn(R(Zt)($))|0)})([0])(o));return[(d.length===0&&u(),xt(0,d.length-1|0,d)),...o]})())],R(qt)(ct(t.lbls))],e=R(qt)(Y(o=>d=>{let i=ce(o);return rt(o)((()=>{if(i.tag==="Just")return i._1;u()})()+Nn(R(Zt)(d))|0)})([0])(a));return[(e.length===0&&u(),xt(0,e.length-1|0,e)),...a]})())]));return()=>{let a=le(r,null,null);return ln(a)}};var At=t=>({bind:n=>r=>a=>t.Bind1().bind(n(a))(e=>r(e._1)(e._2)),Apply0:()=>qn(t)}),qn=t=>{let n=t.Bind1().Apply0().Functor0(),r={map:a=>e=>o=>n.map(d=>p(a(d._1),d._2))(e(o))};return{apply:(()=>{let a=At(t);return e=>o=>a.bind(e)(d=>a.bind(o)(i=>Tt(t).pure(d(i))))})(),Functor0:()=>r}},Tt=t=>({pure:n=>r=>t.Applicative0().pure(p(n,r)),Apply0:()=>qn(t)});var Bn=t=>{let n=t.Monad0(),r={Applicative0:()=>Tt(n),Bind1:()=>At(n)};return{tailRecM:a=>e=>o=>t.tailRecM(d=>n.Bind1().bind(a(d._1)(d._2))(i=>n.Applicative0().pure((()=>{if(i._1.tag==="Loop")return dt("Loop",p(i._1._1,i._2));if(i._1.tag==="Done")return dt("Done",p(i._1._1,i._2));u()})())))(p(e,o)),Monad0:()=>r}},Pn=t=>{let n={Applicative0:()=>Tt(t),Bind1:()=>At(t)};return{state:r=>a=>t.Applicative0().pure(r(a)),Monad0:()=>n}};var kt=(t,n)=>({tag:t,_1:n});var m=(t,n)=>({tag:t,_1:n}),Jn=m("KStop");var Kn=m("KApply"),On=m("KTailApply"),xn=m("KGrab"),Ut=m("KPush"),Wn=m("KPushMark"),ge=m("KReturn");var jn=m("KLet");var kn=m("K_i32_add"),Un=m("K_i32_sub"),zn=m("K_i32_mul"),Qn=m("K_i32_div"),Vn=m("K_i32_mod"),Yn=m("K_i32_equ"),Xn=m("K_i32_neq"),Zn=m("K_i32_le"),Hn=m("K_i32_lt"),vn=m("K_log_and"),tr=m("K_log_or"),er=m("K_log_xor"),nr=m("K_log_not");var ar=t=>({tag:"CodeSection",_1:t});var k=Pn(mt),y=At(mt),Qt=k.state(t=>p(t,t)),De=et(it),w=Tt(mt),Pa=Bn(Ue).tailRecM;var zt=y.bind(Qt)(t=>{let n=Wt(De)(t.ns)(t.next);if(n.tag==="Just"){let r=n._1;return y.bind((()=>{let a={...t,next:bn(De)(e=>h("Just",e+1|0))(t.ns)(t.next)};return k.state(e=>p(void 0,a))})())(()=>w.pure(ee(t.ns,r)))}if(n.tag==="Nothing")return y.bind((()=>{let r={...t,next:Gt(De)(t.ns)(1)(t.next)};return k.state(a=>p(void 0,r))})())(()=>w.pure(ee(t.ns,0)));u()}),ir=t=>(r=>a=>{let e=r,o=a,d=!0,i;for(;d;){let $=e,c=o;if($===0){d=!1,i=c;continue}e=$-1|0,o=_("Cons",xn,c)}return i})(t),Ja=t=>{if(t.tag==="Cons"){if(t._1.tag==="KReturn")return w.pure(p(ge,t));if(t._1.tag==="KBranch")return w.pure(p(t._1,t))}return y.bind(zt)(n=>w.pure(p(m("KBranch",n),_("Cons",m("KLabel",n),t))))};var Ka=t=>n=>r=>t._1.tag==="Nothing"?N("Impossible"):y.bind(Qt)(a=>y.bind((()=>{let e={...a,more:_("Cons",{lbl:t,arity:n,term:r},a.more)};return k.state(o=>p(void 0,e))})())(()=>w.pure(t))),or=t=>{let n=e=>o=>{if(e.tag==="ELVar")return w.pure(_("Cons",m("KAccess",e._2),o));if(e.tag==="ELConst")return w.pure(_("Cons",m("KQuote",e._2),o));if(e.tag==="ELApp"&&o.tag==="Cons"&&o._1.tag==="KReturn")return y.bind(n(e._2)(_("Cons",On,o._2)))(d=>a(e._3)(_("Cons",Ut,d)));if(e.tag==="ELApp"){let d=e._3;return y.bind(n(e._2)(_("Cons",Kn,o)))(i=>{let $=a(d)(_("Cons",Ut,i));return c=>{let l=$(c);return p(_("Cons",Wn,l._1),l._2)}})}if(e.tag==="ELAbs"){if(o.tag==="Cons"&&o._1.tag==="KReturn"){let $=ir(e._2),c=n(e._3)(o);return l=>{let S=c(l);return p($(S._1),S._2)}}let d=e._2,i=e._3;return y.bind((()=>{let $=y.bind(zt)(c=>y.bind(zt)(l=>Ka(c)(d)(i)));return y.bind(c=>{let l=Qt(c);return p(l._1.ns,l._2)})(c=>y.bind(k.state(l=>p(void 0,{...l,ns:h("Just",t)})))(()=>y.bind($)(l=>y.bind(k.state(S=>p(void 0,{...S,ns:c})))(()=>w.pure(l)))))})())($=>w.pure(_("Cons",m("KClosure",$),o)))}if(e.tag==="ELLet"){let d=e._2;return y.bind(n(e._3)(o.tag==="Cons"&&o._1.tag==="KReturn"?o:_("Cons",m("KEndLet",d.length),o)))(i=>{let $=c=>{let l=Ct(S=>g,S=>G=>h("Just",{head:S,tail:G}),c);if(l.tag==="Nothing")return w.pure(i);if(l.tag==="Just"){let S=l._1.head;return y.bind((()=>{let G=$(l._1.tail);return F=>{let q=G(F);return p(_("Cons",jn,q._1),q._2)}})())(G=>n(S)(G))}u()};return $(d)})}return e.tag==="ELPrim"?e._2.tag==="PGetGlobal"?w.pure(_("Cons",m("KGetGlobal",e._2._1),o)):e._2.tag==="PSetGlobal"&&e._3.length===1?n(e._3[0])(_("Cons",m("KSetGlobal",e._2._1),o)):e._2.tag==="PSetGlobal"?N("Impossible"):a(e._3)(e._2.tag==="PAccess"?_("Cons",m("KAccess",e._2._1),o):e._2.tag==="P_i32_add"?_("Cons",kn,o):e._2.tag==="P_i32_sub"?_("Cons",Un,o):e._2.tag==="P_i32_mul"?_("Cons",zn,o):e._2.tag==="P_i32_div"?_("Cons",Qn,o):e._2.tag==="P_i32_mod"?_("Cons",Vn,o):e._2.tag==="P_i32_equ"?_("Cons",Yn,o):e._2.tag==="P_i32_neq"?_("Cons",Xn,o):e._2.tag==="P_i32_le"?_("Cons",Zn,o):e._2.tag==="P_i32_lt"?_("Cons",Hn,o):e._2.tag==="P_log_and"?_("Cons",vn,o):e._2.tag==="P_log_or"?_("Cons",tr,o):e._2.tag==="P_log_not"&&o.tag==="Cons"&&o._1.tag==="KBranchIf"?_("Cons",m("KBranchIfNot",o._1._1),o._2):e._2.tag==="P_log_not"&&o.tag==="Cons"&&o._1.tag==="KBranchIfNot"?_("Cons",m("KBranchIf",o._1._1),o._2):e._2.tag==="P_log_not"?_("Cons",nr,o):e._2.tag==="P_log_xor"?_("Cons",er,o):N("Impoissible")):e.tag==="ELIf"?r(e._2)(e._3)(e._4)(o):N("Not Implemented")},r=e=>o=>d=>i=>y.bind(Ja(i))($=>{let c=$._1,l=$._2;return y.bind(zt)(S=>y.bind(n(d)(l))(G=>y.bind(n(o)(_("Cons",c,_("Cons",m("KLabel",S),G))))(F=>n(e)(_("Cons",m("KBranchIfNot",S),F)))))}),a=e=>o=>{let d=Ct(i=>g,i=>$=>h("Just",{head:i,tail:$}),e);if(d.tag==="Nothing")return w.pure(o);if(d.tag==="Just"&&d._1.tail.length===0)return n(d._1.head)(o);if(d.tag==="Just"){let i=d._1.tail;return y.bind(n(d._1.head)(o))($=>a(i)(_("Cons",Ut,$)))}u()};return n},Oa=t=>{let n=t.ident,r=t.term,a=y.bind(Qt)(i=>sn.traverse(w)($=>{let c=$.head;return y.bind((()=>{let l={...i,more:$.tail};return k.state(S=>p(void 0,l))})())(()=>w.pure(c))})((()=>{if(i.more.tag==="Nil")return g;if(i.more.tag==="Cons")return h("Just",{head:i.more._1,tail:i.more._2});u()})())),e=i=>y.bind(a)($=>{if($.tag==="Just"&&$._1.lbl._1.tag==="Just")return y.bind(or($._1.lbl._1._1)($._1.term)(_("Cons",ge,i)))(c=>$._1.arity===1?e(_("Cons",m("KLabel",$._1.lbl),c)):e(_("Cons",m("KLabel",$._1.lbl),ir($._1.arity-1|0)(c))));if($.tag==="Just")return N("Impossible");if($.tag==="Nothing")return w.pure(i);u()}),o=y.bind(k.state(i=>p(void 0,{...i,ns:h("Just",n)})))(()=>y.bind(e($t))(i=>w.pure(ar({lbl:n,code:(c=>l=>{let S=c,G=l,F=!0,q;for(;F;){let B=S,M=G;if(M.tag==="Nil"){F=!1,q=B;continue}if(M.tag==="Cons"){S=rt(B)(M._1),G=M._2;continue}u()}return q})([])(i)})))),d=y.bind(k.state(i=>p(void 0,{...i,ns:g})))(()=>y.bind(or(n)(r)(n==="it"?_("Cons",Jn,$t):_("Cons",m("KSetGlobal",n),$t)))(i=>w.pure((c=>l=>{let S=c,G=l,F=!0,q;for(;F;){let B=S,M=G;if(M.tag==="Nil"){F=!1,q=B;continue}if(M.tag==="Cons"){S=rt(B)(M._1),G=M._2;continue}u()}return q})([])(i))));return y.bind(k.state(i=>p(void 0,{...i,more:$t})))(()=>y.bind(d)(i=>y.bind(o)($=>w.pure({init:i,text:$}))))},xa=t=>Pa(n=>{let r=Ct(a=>g,a=>e=>h("Just",{head:a,tail:e}),n._1);if(r.tag==="Nothing")return w.pure(dt("Done",n._2));if(r.tag==="Just"){if(r._1.head.tag==="NonRec"){let a=r._1.head._1.ident;return y.bind(Oa({ident:a,term:r._1.head._1.term}))(e=>w.pure(dt("Loop",p(r._1.tail,{...n._2,text:e.text._1.code.length>0?rt(n._2.text)(e.text):n._2.text,init:[...n._2.init,...e.init],syms:rt(n._2.syms)(a)}))))}if(r._1.head.tag==="Rec")return N("Not implemented!")}u()})(p(t.decls,{name:t.name,text:[],data:[],init:[],refs:[],syms:[]})),dr=t=>xa(t)({moduleName:t.name,next:j("Node",1,1,g,0,W,W),init:[],more:$t,ns:g})._1;var ur=(t,n)=>({tag:t,_1:n}),K=(t,n,r,a,e)=>({tag:t,_1:n,_2:r,_3:a,_4:e}),ja=(t,n)=>({tag:t,_1:n});var ye=ja("P_i32_add");function Se(t){return new ArrayBuffer(t)}var Ie=(t,n)=>({tag:t,_1:n}),bs=t=>Ie("InpString",t),Rs=t=>Ie("InpFile",t),za=t=>{let n=_t("Right",{dasmText:()=>"hoge",emitBin:Fn(En(dr({name:"Sample",decls:[ur("NonRec",{ident:"it",term:K("ELLet",void 0,[K("ELAbs",void 0,3,K("ELPrim",void 0,ye,[K("ELVar",void 0,2),K("ELPrim",void 0,ye,[K("ELVar",void 0,1),K("ELVar",void 0,0)])]))],K("ELApp",void 0,K("ELVar",void 0,0),[K("ELConst",void 0,kt("CstInt",1)),K("ELConst",void 0,kt("CstInt",3)),K("ELConst",void 0,kt("CstInt",5))]))})]})))});return()=>n},Ms=t=>{let n=za(Ie("InpString",t));return()=>{let r=n();if(r.tag==="Left")return{success:!1,error:r._1,output:()=>Se(0)};if(r.tag==="Right")return{success:!0,error:null,output:r._1.emitBin};u()}};export{Ie as $CompileInput,Rs as InpFile,bs as InpString,za as compile,Ms as compileJs};
